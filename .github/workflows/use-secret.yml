name: Use GitHub Secret

on: 
  push:
    branches:
      - main  # Runs when you push to main

jobs:
  create-config:
    runs-on: ubuntu-latest  # The VM GitHub uses

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3  # Pulls repo so we can modify files

      - name: Create config file with secret
        env:
          API_KEY: ${{ secrets.MY_SECRET_API_KEY }}
        run: |
          echo '{ apiKey: "$API_KEY" }' > config.json

      - name: Commit and push config file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Ensure we have the latest code
          git pull --rebase https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git main

          git add config.json
          git commit -m "Generated config file with secret" || echo "No changes to commit"

          # Push after pulling latest changes
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

